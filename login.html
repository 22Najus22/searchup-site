<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Machine Status Checker</title>
  <style>
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f5f8fa;
      color: #222;
    }
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 220px;
      background-color: #dc3545;
      color: white;
      display: flex;
      flex-direction: column;
      padding-top: 40px;
      box-shadow: 3px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar button {
      background: none;
      border: none;
      color: white;
      padding: 18px 25px;
      font-size: 1.1em;
      text-align: left;
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .sidebar button:hover,
    .sidebar button.active {
      background-color: #c82333;
      border-left: 4px solid #005fcc;
    }
    .sidebar button:last-child {
      margin-top: auto;
      background-color: #343a40;
    }
    .sidebar button:last-child:hover {
      background-color: #23272b;
    }
    .content {
      flex-grow: 1;
      padding: 40px 50px;
      overflow-y: auto;
      background: white;
    }
    h2 {
      margin-top: 0;
      color: #dc3545;
    }
    form {
      max-width: 800px;
    }
    label {
      display: block;
      margin: 15px 0 6px 0;
      font-weight: bold;
      font-size: 1.1em;
    }
    input[type="text"], input[type="password"], input[type="date"], select, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.8px solid #ccc;
      border-radius: 7px;
      font-size: 1em;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #005fcc;
      outline: none;
    }
    button.submit-btn {
      margin-top: 25px;
      background-color: #dc3545;
      border: none;
      padding: 16px 28px;
      font-size: 1.15em;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button.submit-btn:hover {
      background-color: #c82333;
      transform: scale(1.05);
    }
    .result-card {
      background: #fdfdfd;
      border: 1.5px solid #ccc;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .result-card label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
      font-size: 0.95em;
      color: #444;
    }
    .result-card input,
    .result-card textarea {
      width: 100%;
      margin-top: 5px;
      padding: 10px 12px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
    }
    .result-card button {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container">
 <nav class="sidebar">
    <button class="active" data-target="addData">Add Data / データ追加</button>
    <button data-target="removeData">Remove Data / データ削除</button>
    <button data-target="editData">Edit Data / データ編集</button>
    <button data-target="changeCreds">Change Username & Password / ユーザー名とパスワードの変更</button>
    <!-- ✅ Home Button Added Below -->
    <button onclick="goHome()">🏠 Home / ホームに戻る</button>
  </nav>
  <main class="content">
    <!-- ADD DATA -->
    <section id="addData" class="tab-content">
      <h2>Add Data / データ追加</h2>
      <div style="margin-bottom: 30px; padding: 20px; border: 2px dashed #ccc; border-radius: 10px;">
        <label for="excelFile">Upload Excel File / Excelファイルをアップロード</label>
        <input type="file" id="excelFile" accept=".xlsx, .xls" />
        <p>Accepted columns: SN, 機械ID, 機械名, バージョン, 設置場所, 点検者, 状態, 修理日, 交換部品, 備考</p>
        <button onclick="handleExcelUpload()" class="submit-btn">Upload / アップロード</button>
      </div>
      <form id="addDataForm" autocomplete="off">
        <label for="sn">SN</label>
        <input type="text" name="sn" required autocomplete="off">
        <label for="machineId">機械ID (Machine ID)</label>
        <input type="text" name="machineId" required autocomplete="off">
        <label for="machineName">機械名 (Machine Name)</label>
        <input type="text" name="machineName" required autocomplete="off">
        <label for="version">バージョン (Version)</label>
        <input type="text" name="version" required autocomplete="off">
        <label for="location">設置場所 (Location)</label>
        <input type="text" name="location" autocomplete="off">
        <label for="inspector">点検者 (Inspector)</label>
        <input type="text" name="inspector" autocomplete="off">
        <label for="status">状態 (Status)</label>
        <select name="status" required>
          <option value="" disabled selected>Select status</option>
          <option value="operational">Operational / 稼働中</option>
          <option value="maintenance">Maintenance / メンテナンス中</option>
          <option value="offline">Offline / オフライン</option>
        </select>
        <label for="repairDate">修理日 (Repair Date)</label>
        <input type="date" name="repairDate" autocomplete="off">
        <label for="replacement">交換部品 (Replacement Parts)</label>
        <input type="text" name="replacement" autocomplete="off">
        <label for="remarks">備考 (Remarks)</label>
        <textarea name="remarks" rows="3" autocomplete="off"></textarea>
        <button type="submit" class="submit-btn">Add / 追加</button>
      </form>
    </section>

    <!-- REMOVE DATA -->
    <section id="removeData" class="tab-content" hidden>
      <h2>Remove Data / データ削除</h2>
      <label>Search by Machine ID:</label>
      <input type="text" id="removeSearchInput" placeholder="Enter Machine ID" autocomplete="off">
      <button onclick="searchAndShowForRemoval()" class="submit-btn">Search / 検索</button>
      <div id="removeResult"></div>
    </section>

    <!-- EDIT DATA -->
    <section id="editData" class="tab-content" hidden>
      <h2>Edit Data / データ編集</h2>
      <label>Search by Machine ID:</label>
      <input type="text" id="editSearchInput" placeholder="Enter Machine ID" autocomplete="off">
      <button onclick="searchAndShowForEdit()" class="submit-btn">Search / 検索</button>
      <div id="editResult"></div>
    </section>

    <!-- CHANGE CREDENTIALS -->
    <section id="changeCreds" class="tab-content" hidden>
      <h2>Change Username & Password / ユーザー名とパスワードの変更</h2>
      <form id="changeCredsForm" autocomplete="off">
        <label for="oldUsername">Old Username</label>
        <input type="text" id="oldUsername" required autocomplete="off">
        <label for="oldPassword">Old Password</label>
        <input type="password" id="oldPassword" required autocomplete="off">
        <label for="newUsername">New Username</label>
        <input type="text" id="newUsername" required autocomplete="off">
        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" required autocomplete="off">
        <button type="submit" class="submit-btn">Update Credentials / 資格情報の更新</button>
      </form>
      <p id="credsMessage" style="margin-top: 20px;"></p>
    </section>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const API_URL = "https://sheetdb.io/api/v1/yg3eapqraogpe";

  const buttons = document.querySelectorAll('.sidebar button');
  const sections = document.querySelectorAll('.tab-content');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      sections.forEach(s => s.hidden = true);

      document.getElementById("removeSearchInput").value = "";
      document.getElementById("removeResult").innerHTML = "";

      document.getElementById("editSearchInput").value = "";
      document.getElementById("editResult").innerHTML = "";

      document.getElementById("changeCredsForm").reset();
      document.getElementById("credsMessage").innerHTML = "";

      btn.classList.add('active');
      document.getElementById(btn.getAttribute('data-target')).hidden = false;
    });
  });

  let machineData = [];

  // Fetch data from API on load
  async function fetchMachineData() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error("Failed to fetch data from API");
      const data = await res.json();

      // Normalize data keys to match your internal keys
      machineData = data.map(item => ({
        sn: item.SN || "",
        machineId: item["機械ID"]?.trim() || item["Machine ID"]?.trim() || "",
        machineName: item["機械名"] || item["Machine Name"] || "",
        version: item["バージョン"] || item["Version"] || "",
        location: item["設置場所"] || item["Location"] || "",
        inspector: item["点検者"] || item["Inspector"] || "",
        status: item["状態"] || item["Status"] || "",
        repairDate: item["修理日"] || item["Repair Date"] || "",
        replacement: item["交換部品"] || item["Replacement Parts"] || "",
        remarks: item["備考"] || item["Remarks"] || ""
      }));

      console.log("Machine Data loaded from API:", machineData);
    } catch (error) {
      alert("Error loading data from API: " + error.message);
    }
  }

  fetchMachineData();

  // Add Data Form Submission
  document.getElementById('addDataForm').addEventListener('submit', e => {
    e.preventDefault();
    const form = e.target;

    const newMachine = {
      sn: form.sn.value.trim(),
      machineId: form.machineId.value.trim(),
      machineName: form.machineName.value.trim(),
      version: form.version.value.trim(),
      location: form.location.value.trim(),
      inspector: form.inspector.value.trim(),
      status: form.status.value,
      repairDate: form.repairDate.value,
      replacement: form.replacement.value.trim(),
      remarks: form.remarks.value.trim()
    };

    // Check for duplicates by SN or machineId
    if (machineData.some(m => m.sn === newMachine.sn || m.machineId === newMachine.machineId)) {
      alert("Duplicate SN or Machine ID found. Please use unique values.");
      return;
    }

    machineData.push(newMachine);
    alert("Data added locally. Note: Changes are not saved to remote API automatically.");
    form.reset();
  });

  // REMOVE DATA functions
  function searchAndShowForRemoval() {
    const id = document.getElementById('removeSearchInput').value.trim();
    const resultDiv = document.getElementById('removeResult');
    resultDiv.innerHTML = "";

    if (!id) {
      alert("Please enter a Machine ID to search.");
      return;
    }

    const found = machineData.find(m => m.machineId === id);
    if (!found) {
      resultDiv.innerHTML = `<p>No machine found with Machine ID: ${id}</p>`;
      return;
    }

    resultDiv.innerHTML = `
  <div class="result-card">
    <label>SN</label><input type="text" value="${found.sn}" readonly>
    <label>機械ID (Machine ID)</label><input type="text" value="${found.machineId}" readonly>
    <label>機械名 (Machine Name)</label><input type="text" value="${found.machineName}" readonly>
    <label>バージョン (Version)</label><input type="text" value="${found.version}" readonly>
    <label>設置場所 (Location)</label><input type="text" value="${found.location}" readonly>
    <label>点検者 (Inspector)</label><input type="text" value="${found.inspector}" readonly>
    <label>状態 (Status)</label><input type="text" value="${found.status}" readonly>
    <label>修理日 (Repair Date)</label><input type="text" value="${found.repairDate}" readonly>
    <label>交換部品 (Replacement Parts)</label><input type="text" value="${found.replacement}" readonly>
    <label>備考 (Remarks)</label><textarea readonly rows="3">${found.remarks}</textarea>
    <button onclick="removeMachine('${found.machineId}')" class="submit-btn">Remove / 削除</button>
  </div>
`;

  }

  function removeMachine(machineId) {
    if (!confirm("Are you sure you want to delete this machine data? / 本当に削除しますか？")) return;
    machineData = machineData.filter(m => m.machineId !== machineId);
    alert("Data removed locally. Note: Changes are not saved to remote API automatically.");
    document.getElementById('removeResult').innerHTML = "";
    document.getElementById('removeSearchInput').value = "";
  }

  // EDIT DATA functions
  function searchAndShowForEdit() {
    const id = document.getElementById('editSearchInput').value.trim();
    const resultDiv = document.getElementById('editResult');
    resultDiv.innerHTML = "";

    if (!id) {
      alert("Please enter a Machine ID to search.");
      return;
    }

    const found = machineData.find(m => m.machineId === id);
    if (!found) {
      resultDiv.innerHTML = `<p>No machine found with Machine ID: ${id}</p>`;
      return;
    }

    resultDiv.innerHTML = `
      <form id="editForm" autocomplete="off">
        <label for="editSn">SN</label>
        <input type="text" id="editSn" value="${found.sn}" required readonly>

        <label for="editMachineId">機械ID (Machine ID)</label>
        <input type="text" id="editMachineId" value="${found.machineId}" required readonly>

        <label for="editMachineName">機械名 (Machine Name)</label>
        <input type="text" id="editMachineName" value="${found.machineName}" required>

        <label for="editVersion">バージョン (Version)</label>
        <input type="text" id="editVersion" value="${found.version}" required>

        <label for="editLocation">設置場所 (Location)</label>
        <input type="text" id="editLocation" value="${found.location}">

        <label for="editInspector">点検者 (Inspector)</label>
        <input type="text" id="editInspector" value="${found.inspector}">

        <label for="editStatus">状態 (Status)</label>
        <select id="editStatus" required>
          <option value="operational" ${found.status === 'operational' ? 'selected' : ''}>Operational / 稼働中</option>
          <option value="maintenance" ${found.status === 'maintenance' ? 'selected' : ''}>Maintenance / メンテナンス中</option>
          <option value="offline" ${found.status === 'offline' ? 'selected' : ''}>Offline / オフライン</option>
        </select>

        <label for="editRepairDate">修理日 (Repair Date)</label>
        <input type="date" id="editRepairDate" value="${found.repairDate}">

        <label for="editReplacement">交換部品 (Replacement Parts)</label>
        <input type="text" id="editReplacement" value="${found.replacement}">

        <label for="editRemarks">備考 (Remarks)</label>
        <textarea id="editRemarks" rows="3">${found.remarks}</textarea>

        <button type="submit" class="submit-btn">Update / 更新</button>
      </form>
    `;

    document.getElementById('editForm').addEventListener('submit', e => {
      e.preventDefault();
      const idx = machineData.findIndex(m => m.machineId === id);
      if (idx === -1) {
        alert("Machine not found.");
        return;
      }
      machineData[idx].machineName = document.getElementById('editMachineName').value.trim();
      machineData[idx].version = document.getElementById('editVersion').value.trim();
      machineData[idx].location = document.getElementById('editLocation').value.trim();
      machineData[idx].inspector = document.getElementById('editInspector').value.trim();
      machineData[idx].status = document.getElementById('editStatus').value;
      machineData[idx].repairDate = document.getElementById('editRepairDate').value;
      machineData[idx].replacement = document.getElementById('editReplacement').value.trim();
      machineData[idx].remarks = document.getElementById('editRemarks').value.trim();

      alert("Data updated locally. Note: Changes are not saved to remote API automatically.");
      document.getElementById('editResult').innerHTML = "";
      document.getElementById('editSearchInput').value = "";
    });
  }

  // Change Credentials Form
  const credsForm = document.getElementById('changeCredsForm');
  credsForm.addEventListener('submit', e => {
    e.preventDefault();

    const oldUser = document.getElementById('oldUsername').value.trim();
    const oldPass = document.getElementById('oldPassword').value.trim();
    const newUser = document.getElementById('newUsername').value.trim();
    const newPass = document.getElementById('newPassword').value.trim();
    const message = document.getElementById('credsMessage');

    // For demo, store credentials in localStorage
    const storedUser = localStorage.getItem('adminUser') || 'admin';
    const storedPass = localStorage.getItem('adminPass') || 'password';

    if (oldUser !== storedUser || oldPass !== storedPass) {
      message.style.color = 'red';
      message.textContent = 'Old username or password is incorrect.';
      return;
    }

    localStorage.setItem('adminUser', newUser);
    localStorage.setItem('adminPass', newPass);

    message.style.color = 'green';
    message.textContent = 'Credentials updated successfully!';
    credsForm.reset();
  });

  // Excel upload handler
  function handleExcelUpload() {
    const fileInput = document.getElementById('excelFile');
    if (!fileInput.files || fileInput.files.length === 0) {
      alert("Please select an Excel file first.");
      return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
      const data = e.target.result;
      const workbook = XLSX.read(data, {type: 'binary'});
      const firstSheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheetName];
      const json = XLSX.utils.sheet_to_json(worksheet);

      json.forEach(row => {
        // Map Excel columns to internal keys
        const newEntry = {
          sn: row.SN || "",
          machineId: (row["機械ID"] || row["Machine ID"] || "").trim(),
          machineName: row["機械名"] || row["Machine Name"] || "",
          version: row["バージョン"] || row["Version"] || "",
          location: row["設置場所"] || row["Location"] || "",
          inspector: row["点検者"] || row["Inspector"] || "",
          status: row["状態"] || row["Status"] || "",
          repairDate: row["修理日"] || row["Repair Date"] || "",
          replacement: row["交換部品"] || row["Replacement Parts"] || "",
          remarks: row["備考"] || row["Remarks"] || ""
        };

        if (!newEntry.machineId) return; // skip invalid row

        // Avoid duplicates
        if (!machineData.some(m => m.machineId === newEntry.machineId)) {
          machineData.push(newEntry);
        }
      });

      alert("Excel data uploaded locally. Note: Changes are not saved to remote API automatically.");
      fileInput.value = "";
    };

    reader.readAsBinaryString(file);
  }

  // Home button function
  function goHome() {
    window.location.href = "index.html";
  }
</script>
</body>
</html>
